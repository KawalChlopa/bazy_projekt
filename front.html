<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BukMaker - System Bukmacherski</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #34495e;
            --accent-color: #3498db;
        }
        
        body {
            background-color: #f8f9fa;
        }

        .navbar {
            background-color: var(--primary-color) !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .card {
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .search-bar {
            max-width: 600px;
            margin: 20px auto;
        }

        .balance-card {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: white;
        }

        .bet-card {
            margin-bottom: 20px;
        }

        .status-badge {
            position: absolute;
            top: 10px;
            right: 10px;
        }

        .profile-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .loading-spinner {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
            background: rgba(255,255,255,0.8);
            padding: 20px;
            border-radius: 10px;
            display: none;
        }

        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <!-- Loading Spinner -->
    <div class="loading-spinner" id="loadingSpinner">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Ładowanie...</span>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-futbol me-2"></i>BukMaker
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showMatches()">
                            <i class="fas fa-list me-1"></i>Mecze
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showBets()">
                            <i class="fas fa-ticket-alt me-1"></i>Moje Zakłady
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showProfile()">
                            <i class="fas fa-user me-1"></i>Mój Profil
                        </a>
                    </li>
                </ul>
                <div id="userInfo" class="d-none">
                    <span class="text-light me-3">
                        <i class="fas fa-wallet me-1"></i>
                        <span id="userBalance">0.00 PLN</span>
                    </span>
                </div>
                <div class="d-flex" id="authButtons">
                    <button class="btn btn-outline-light me-2" onclick="showLoginForm()">
                        <i class="fas fa-sign-in-alt me-1"></i>Zaloguj
                    </button>
                    <button class="btn btn-light" onclick="showRegisterForm()">
                        <i class="fas fa-user-plus me-1"></i>Rejestracja
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container py-4">
        <!-- Search Bar -->
        <div class="search-bar" id="searchBar" style="display: none;">
            <div class="input-group">
                <input type="text" class="form-control" placeholder="Wyszukaj mecz..." id="searchInput">
                <button class="btn btn-primary" type="button" onclick="searchMatches()">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </div>

        <!-- Login Form -->
        <div id="loginForm" class="card mx-auto" style="max-width: 400px; display: none;">
            <div class="card-body">
                <h3 class="card-title text-center mb-4">Logowanie</h3>
                <form onsubmit="login(event)">
                    <div class="mb-3">
                        <label class="form-label">Nazwa użytkownika</label>
                        <input type="text" class="form-control" id="loginUsername" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Hasło</label>
                        <input type="password" class="form-control" id="loginPassword" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-sign-in-alt me-2"></i>Zaloguj się
                    </button>
                </form>
            </div>
        </div>

        <!-- Register Form -->
        <div id="registerForm" class="card mx-auto" style="max-width: 400px; display: none;">
            <div class="card-body">
                <h3 class="card-title text-center mb-4">Rejestracja</h3>
                <form onsubmit="register(event)">
                    <div class="mb-3">
                        <label class="form-label">Nazwa użytkownika</label>
                        <input type="text" class="form-control" id="registerUsername" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" id="registerEmail" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Hasło</label>
                        <input type="password" class="form-control" id="registerPassword" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-user-plus me-2"></i>Zarejestruj się
                    </button>
                </form>
            </div>
        </div>

        <!-- Matches List -->
        <div id="matchesList" style="display: none;">
            <div class="row" id="matchesContainer"></div>
        </div>

        <!-- Profile Section -->
        <div id="profileSection" style="display: none;">
            <div class="row">
                <div class="col-md-4">
                    <div class="profile-section">
                        <h4><i class="fas fa-user-circle me-2"></i>Informacje o koncie</h4>
                        <div id="profileInfo"></div>
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="profile-section">
                        <h4><i class="fas fa-chart-line me-2"></i>Statystyki zakładów</h4>
                        <div id="betStats"></div>
                    </div>
                </div>
            </div>
            <div class="profile-section mt-4">
                <h4><i class="fas fa-history me-2"></i>Historia transakcji</h4>
                <div id="transactionHistory"></div>
            </div>
        </div>

        <!-- Bets List -->
        <div id="betsList" style="display: none;">
            <h3 class="mb-4"><i class="fas fa-ticket-alt me-2"></i>Moje zakłady</h3>
            <div id="betsContainer"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_URL = 'http://localhost:5000/api';
        let currentUser = null;

        // Pomocnicze funkcje
        function showSpinner() {
            document.getElementById('loadingSpinner').style.display = 'flex';
        }

        function hideSpinner() {
            document.getElementById('loadingSpinner').style.display = 'none';
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast show bg-${type} text-white`;
            toast.innerHTML = `
                <div class="toast-body">
                    ${message}
                    <button type="button" class="btn-close btn-close-white float-end" 
                            data-bs-dismiss="toast"></button>
                </div>
            `;
            document.getElementById('toastContainer').appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // Funkcje nawigacji
        function showPage(pageId) {
            const pages = ['loginForm', 'registerForm', 'matchesList', 'betsList', 'profileSection'];
            pages.forEach(page => {
                document.getElementById(page).style.display = page === pageId ? 'block' : 'none';
            });
            document.getElementById('searchBar').style.display = 
                pageId === 'matchesList' ? 'block' : 'none';
        }

        // Funkcje autoryzacji
        async function login(event) {
    event.preventDefault();
    showSpinner();
    try {
        const response = await fetch(`${API_URL}/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                nazwa: document.getElementById('loginUsername').value,
                haslo: document.getElementById('loginPassword').value
            })
        });

        const data = await response.json();
        if (!response.ok) throw new Error(data.error);

        // Zapisujemy dane użytkownika z zachowaniem id z serwera
        currentUser = {
            id: data.user.id,  // Używamy id dokładnie tak jak przychodzi z serwera
            nazwa: data.user.nazwa,
            email: data.user.email,
            balans: data.user.balans,
            rola: data.user.rola
        };
        
        localStorage.setItem('user', JSON.stringify(currentUser));
        
        updateUIAfterLogin();
        showToast('Zalogowano pomyślnie!');
        showMatches();
    } catch (error) {
        showToast(error.message, 'danger');
    } finally {
        hideSpinner();
    }
}

        async function register(event) {
            event.preventDefault();
            showSpinner();
            try {
                const response = await fetch(`${API_URL}/konto`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        nazwa: document.getElementById('registerUsername').value,
                        email: document.getElementById('registerEmail').value,
                        haslo: document.getElementById('registerPassword').value
                    })
                });

                const data = await response.json();
                if (!response.ok) throw new Error(data.error);

                showToast('Konto zostało utworzone. Sprawdź email aby je aktywować.');
                showLoginForm();
            } catch (error) {
                showToast(error.message, 'danger');
            } finally {
                hideSpinner();
            }
        }

        function updateUIAfterLogin() {
            document.getElementById('userInfo').classList.remove('d-none');
            document.getElementById('userBalance').textContent = `${currentUser.balans} PLN`;
            document.getElementById('authButtons').innerHTML = `
                <button class="btn btn-outline-light" onclick="logout()">
                    <i class="fas fa-sign-out-alt me-1"></i>Wyloguj
                </button>
            `;
        }

        // Funkcje wyświetlania danych
        async function showMatches() {
            if (!currentUser) {
                showToast('Zaloguj się aby zobaczyć mecze', 'warning');
                showLoginForm();
                return;
            }

            showSpinner();
            try {
                const response = await fetch(`${API_URL}/konto/find_match?search=all`);
                const matches = await response.json();
                
                const container = document.getElementById('matchesContainer');
                container.innerHTML = '';

                if (matches.length === 0) {
                    container.innerHTML = `
                        <div class="col-12">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>Brak dostępnych meczów
                            </div>
                        </div>
                    `;
                    return;
                }

                matches.forEach(match => {
                    const card = document.createElement('div');
                    card.className = 'col-md-6 col-lg-4 mb-4';
                    card.innerHTML = `
                        <div class="card bet-card">
                            <div class="card-body">
                                <span class="status-badge badge ${match.status === 'Oczekujący' 
                                    ? 'bg-success' : 'bg-secondary'}">
                                    ${match.status}
                                </span>
                                <h5 class="card-title">${match.gospodarz} vs ${match.gosc}</h5>
                                <p class="card-text">
                                    <i class="far fa-calendar me-2"></i>
                                    ${new Date(match.data_meczu).toLocaleString()}
                                </p>
                                <div id="kursy-${match.id_meczu}" class="mb-3"></div>
                                ${match.status === 'Oczekujący' ? `
                                    <div class="input-group mt-3">
                                        <input type="number" class="form-control" id="kwota-${match.id_meczu}"
                                               placeholder="Kwota zakładu" min="1" step="0.01">
                                        <button class="btn btn-primary" onclick="placeBet(${match.id_meczu})">
                                            <i class="fas fa-check me-1"></i>Postaw
                                        </button>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                    container.appendChild(card);
                    loadMatchOdds(match.id_meczu);
                });

                showPage('matchesList');
            } catch (error) {
                showToast(error.message, 'danger');
            } finally {
                hideSpinner();
            }
        }

        async function loadMatchOdds(matchId) {
            try {
                const response = await fetch(`${API_URL}/mecz/${matchId}/kursy`);
                const odds = await response.json();
                
                const container = document.getElementById(`kursy-${matchId}`);
                if (!container) return;

                if (odds.length === 0) {
                    container.innerHTML = `
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>Brak dostępnych kursów
                        </div>
                    `;
                    return;
                }

                container.innerHTML = `<h6 class="mb-3">Dostępne kursy:</h6>`;
                odds.forEach(odd => {
                    const oddDiv = document.createElement('div');
                    oddDiv.className = 'form-check mb-2';
                    oddDiv.innerHTML = `
                        <input class="form-check-input" type="radio" 
                               name="kurs-${matchId}" value="${odd.id}" 
                               id="kurs-${odd.id}">
                        <label class="form-check-label" for="kurs-${odd.id}">
                            ${odd.nazwa_typu}: <span class="badge bg-primary">${odd.kurs}</span>
                        </label>
                    `;
                    container.appendChild(oddDiv);
                });
            } catch (error) {
                console.error('Błąd podczas pobierania kursów:', error);
            }
        }

        async function placeBet(matchId) {
    const kursRadio = document.querySelector(`input[name="kurs-${matchId}"]:checked`);
    const kwotaInput = document.getElementById(`kwota-${matchId}`);

    if (!kursRadio) {
        showToast('Wybierz typ zakładu', 'warning');
        return;
    }

    if (!kwotaInput.value || kwotaInput.value <= 0) {
        showToast('Wprowadź prawidłową kwotę', 'warning');
        return;
    }

    showSpinner();
    try {
        const response = await fetch(`${API_URL}/zaklad`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                id_kursu: kursRadio.value,
                kwota_postawiona: parseFloat(kwotaInput.value),
                id_uzytkownika: currentUser.id
            })
        });

        const data = await response.json();
        if (!response.ok) throw new Error(data.error);

        showToast('Zakład został pomyślnie postawiony!');
        updateUserBalance();
        showBets();
    } catch (error) {
        showToast(error.message, 'danger');
    } finally {
        hideSpinner();
    }
}   

        async function showBets() {
            if (!currentUser) {
                showToast('Zaloguj się aby zobaczyć swoje zakłady', 'warning');
                showLoginForm();
                return;
            }

            showSpinner();
            try {
                const response = await fetch(`${API_URL}/zaklady/${currentUser.id}`);
                const bets = await response.json();

                const container = document.getElementById('betsContainer');
                container.innerHTML = '';

                if (bets.length === 0) {
                    container.innerHTML = `
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>Nie masz jeszcze żadnych zakładów
                        </div>
                    `;
                    return;
                }

                bets.forEach(bet => {
                    const card = document.createElement('div');
                    card.className = 'card mb-3';
                    card.innerHTML = `
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="card-title mb-0">${bet.nazwa_meczu}</h5>
                                <span class="badge ${getBetStatusClass(bet.status_zakladu)}">
                                    ${bet.status_zakladu}
                                </span>
                            </div>
                            <hr>
                            <div class="row">
                                <div class="col-md-6">
                                    <p><i class="fas fa-dice me-2"></i>Typ: ${bet.nazwa_typu}</p>
                                    <p><i class="fas fa-money-bill me-2"></i>Kurs: ${bet.kurs}</p>
                                </div>
                                <div class="col-md-6 text-md-end">
                                    <p>Postawiono: ${bet.kwota_postawiona} PLN</p>
                                    <p>Możliwa wygrana: ${bet.potencjalna_wygrana} PLN</p>
                                </div>
                            </div>
                        </div>
                    `;
                    container.appendChild(card);
                });

                showPage('betsList');
            } catch (error) {
                showToast(error.message, 'danger');
            } finally {
                hideSpinner();
            }
        }

        async function showProfile() {
            if (!currentUser) {
                showToast('Zaloguj się aby zobaczyć swój profil', 'warning');
                showLoginForm();
                return;
            }

            showSpinner();
            try {
                const response = await fetch(`${API_URL}/konto/${currentUser.id}/bilans`);
                const data = await response.json();

                document.getElementById('profileInfo').innerHTML = `
                    <p><strong>Nazwa użytkownika:</strong> ${currentUser.nazwa}</p>
                    <p><strong>Email:</strong> ${currentUser.email}</p>
                    <p><strong>Aktualny balans:</strong> ${currentUser.balans} PLN</p>
                `;

                document.getElementById('betStats').innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <p><i class="fas fa-trophy text-success me-2"></i>
                               Wygrane: ${data.statystyki.wygrane_zaklady}</p>
                            <p><i class="fas fa-times text-danger me-2"></i>
                               Przegrane: ${data.statystyki.przegrane_zaklady}</p>
                        </div>
                        <div class="col-md-6">
                            <p><i class="fas fa-plus-circle text-success me-2"></i>
                               Suma wygranych: ${data.statystyki.suma_wygranych} PLN</p>
                            <p><i class="fas fa-minus-circle text-danger me-2"></i>
                               Suma przegranych: ${data.statystyki.suma_przegranych} PLN</p>
                        </div>
                    </div>
                    <div class="progress mt-3">
                        <div class="progress-bar bg-success" 
                             style="width: ${data.statystyki.procent_wygranych}%">
                            ${data.statystyki.procent_wygranych}% wygranych
                        </div>
                    </div>
                `;

                const transactionTable = `
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Typ</th>
                                    <th>Kwota</th>
                                    <th>Saldo</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.ostatnie_operacje.map(op => `
                                    <tr>
                                        <td>${new Date(op.data).toLocaleString()}</td>
                                        <td>${op.typ_operacji}</td>
                                        <td class="${Number(op.zmiana_balansu) > 0 ? 'text-success' : 'text-danger'}">
                                            ${Number(op.zmiana_balansu) > 0 ? '+' : ''}${op.kwota} PLN
                                        </td>
                                        <td>${op.saldo_po_operacji} PLN</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;

                document.getElementById('transactionHistory').innerHTML = transactionTable;

                showPage('profileSection');
            } catch (error) {
                showToast(error.message, 'danger');
            } finally {
                hideSpinner();
            }
        }

        async function searchMatches() {
    if (!currentUser) {
        showToast('Zaloguj się aby wyszukiwać mecze', 'warning');
        showLoginForm();
        return;
    }

    const query = document.getElementById('searchInput').value;
    showSpinner();
    
    try {
        const response = await fetch(`${API_URL}/konto/find_match?search=${encodeURIComponent(query)}`);
        const matches = await response.json();
        
        const container = document.getElementById('matchesContainer');
        container.innerHTML = '';

        if (matches.length === 0) {
            container.innerHTML = `
                <div class="col-12">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>Brak dostępnych meczów
                    </div>
                </div>
            `;
            return;
        }

        matches.forEach(match => {
            const card = document.createElement('div');
            card.className = 'col-md-6 col-lg-4 mb-4';
            card.innerHTML = `
                <div class="card bet-card">
                    <div class="card-body">
                        <span class="status-badge badge ${match.status === 'Oczekujący' 
                            ? 'bg-success' : 'bg-secondary'}">
                            ${match.status}
                        </span>
                        <h5 class="card-title">${match.gospodarz} vs ${match.gosc}</h5>
                        <p class="card-text">
                            <i class="far fa-calendar me-2"></i>
                            ${new Date(match.data_meczu).toLocaleString()}
                        </p>
                        <div id="kursy-${match.id_meczu}" class="mb-3"></div>
                        ${match.status === 'Oczekujący' ? `
                            <div class="input-group mt-3">
                                <input type="number" class="form-control" id="kwota-${match.id_meczu}"
                                       placeholder="Kwota zakładu" min="1" step="0.01">
                                <button class="btn btn-primary" onclick="placeBet(${match.id_meczu})">
                                    <i class="fas fa-check me-1"></i>Postaw
                                </button>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
            container.appendChild(card);
            loadMatchOdds(match.id_meczu);
        });
    } catch (error) {
        showToast(error.message, 'danger');
    } finally {
        hideSpinner();
    }
}

        async function updateUserBalance() {
            if (!currentUser) return;
            try {
                const response = await fetch(`${API_URL}/konto/${currentUser.id}/bilans`);
                const data = await response.json();
                document.getElementById('userBalance').textContent = 
                    `${data.statystyki.balans || '0.00'} PLN`;
            } catch (error) {
                console.error('Błąd podczas aktualizacji balansu:', error);
            }
        }

        function showLoginForm() {
            showPage('loginForm');
        }

        function showRegisterForm() {
            showPage('registerForm');
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('user');
            document.getElementById('userInfo').classList.add('d-none');
            document.getElementById('authButtons').innerHTML = `
                <button class="btn btn-outline-light me-2" onclick="showLoginForm()">
                    <i class="fas fa-sign-in-alt me-1"></i>Zaloguj
                </button>
                <button class="btn btn-light" onclick="showRegisterForm()">
                    <i class="fas fa-user-plus me-1"></i>Rejestracja
                </button>
            `;
            showLoginForm();
        }

        // Inicjalizacja
        document.addEventListener('DOMContentLoaded', () => {
            const savedUser = localStorage.getItem('user');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                updateUIAfterLogin();
                showMatches();
            } else {
                showLoginForm();
            }
        });
    </script>
</body>
</html>